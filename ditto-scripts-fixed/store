#!/data/data/com.termux/files/usr/bin/bash
# DITTO STORE - App Discovery and Installation
# Part of MobileCLI DITTO Ecosystem

STORE_DIR="$HOME/.ditto/store"
CACHE_DIR="$HOME/.ditto/cache"
INDEX_URL="https://raw.githubusercontent.com/MobileDevCLI/ditto-store/main/index.json"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

mkdir -p "$STORE_DIR" "$CACHE_DIR"

show_help() {
    echo -e "${CYAN}╔════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║      DITTO STORE - App Discovery       ║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${YELLOW}Commands:${NC}"
    echo "  store browse              - Browse all apps"
    echo "  store search <query>      - Search for apps"
    echo "  store info <app-id>       - Show app details"
    echo "  store install <app-id>    - Install an app"
    echo "  store uninstall <app-id>  - Remove an app"
    echo "  store update              - Update all apps"
    echo "  store installed           - List installed apps"
    echo "  store submit              - Submit your app"
    echo "  store sync                - Refresh app index"
    echo ""
    echo -e "${YELLOW}Categories:${NC}"
    echo "  store cat tools           - Browse tools"
    echo "  store cat themes          - Browse themes"
    echo "  store cat scripts         - Browse scripts"
    echo "  store cat games           - Browse games"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  store search editor"
    echo "  store install code-editor"
    echo "  store cat themes"
}

# Sync store index
sync_index() {
    echo -e "${CYAN}Syncing store index...${NC}"

    # Try to fetch from GitHub (use -f to fail on HTTP errors)
    local temp_file="$CACHE_DIR/index_temp.json"
    if curl -sfL "$INDEX_URL" -o "$temp_file" 2>/dev/null; then
        # Verify it's valid JSON before replacing
        if python3 -c "import json; json.load(open('$temp_file'))" 2>/dev/null; then
            mv "$temp_file" "$CACHE_DIR/index.json"
            echo -e "${GREEN}Index updated from remote${NC}"
        else
            rm -f "$temp_file"
            create_local_index
            echo -e "${YELLOW}Remote index invalid, using local${NC}"
        fi
    else
        rm -f "$temp_file" 2>/dev/null
        # Create local index
        create_local_index
        echo -e "${YELLOW}Using local index${NC}"
    fi
}

# Create initial local index with built-in apps
create_local_index() {
    cat > "$CACHE_DIR/index.json" << 'INDEXEOF'
{
  "version": 1,
  "updated": "2026-01-07",
  "apps": [
    {
      "id": "neofetch",
      "name": "Neofetch",
      "version": "7.1.0",
      "author": "dylanaraps",
      "description": "System information tool with ASCII art",
      "category": "tools",
      "install_type": "pkg",
      "install_cmd": "pkg install neofetch -y",
      "size": "50KB"
    },
    {
      "id": "htop",
      "name": "htop",
      "version": "3.3.0",
      "author": "htop-dev",
      "description": "Interactive process viewer",
      "category": "tools",
      "install_type": "pkg",
      "install_cmd": "pkg install htop -y",
      "size": "200KB"
    },
    {
      "id": "nano",
      "name": "GNU Nano",
      "version": "8.0",
      "author": "GNU",
      "description": "Easy-to-use text editor",
      "category": "tools",
      "install_type": "pkg",
      "install_cmd": "pkg install nano -y",
      "size": "500KB"
    },
    {
      "id": "vim",
      "name": "Vim",
      "version": "9.1",
      "author": "Bram Moolenaar",
      "description": "Powerful text editor",
      "category": "tools",
      "install_type": "pkg",
      "install_cmd": "pkg install vim -y",
      "size": "3MB"
    },
    {
      "id": "tmux",
      "name": "tmux",
      "version": "3.4",
      "author": "tmux",
      "description": "Terminal multiplexer",
      "category": "tools",
      "install_type": "pkg",
      "install_cmd": "pkg install tmux -y",
      "size": "800KB"
    },
    {
      "id": "ffmpeg",
      "name": "FFmpeg",
      "version": "6.1",
      "author": "FFmpeg team",
      "description": "Audio/video converter and streamer",
      "category": "tools",
      "install_type": "pkg",
      "install_cmd": "pkg install ffmpeg -y",
      "size": "50MB"
    },
    {
      "id": "imagemagick",
      "name": "ImageMagick",
      "version": "7.1",
      "author": "ImageMagick Studio",
      "description": "Image manipulation toolkit",
      "category": "tools",
      "install_type": "pkg",
      "install_cmd": "pkg install imagemagick -y",
      "size": "20MB"
    },
    {
      "id": "theme-hacker",
      "name": "Hacker Theme",
      "version": "1.0.0",
      "author": "MobileCLI",
      "description": "Green on black matrix style",
      "category": "themes",
      "install_type": "ditto",
      "install_cmd": "ditto theme hacker",
      "size": "1KB"
    },
    {
      "id": "theme-ocean",
      "name": "Ocean Theme",
      "version": "1.0.0",
      "author": "MobileCLI",
      "description": "Deep blue calming theme",
      "category": "themes",
      "install_type": "ditto",
      "install_cmd": "ditto theme ocean",
      "size": "1KB"
    },
    {
      "id": "theme-light",
      "name": "Light Theme",
      "version": "1.0.0",
      "author": "MobileCLI",
      "description": "White background for daylight",
      "category": "themes",
      "install_type": "ditto",
      "install_cmd": "ditto theme light",
      "size": "1KB"
    },
    {
      "id": "youtube-dl",
      "name": "yt-dlp",
      "version": "2024.01",
      "author": "yt-dlp",
      "description": "Download videos from YouTube and more",
      "category": "tools",
      "install_type": "pkg",
      "install_cmd": "pkg install yt-dlp -y",
      "size": "5MB"
    },
    {
      "id": "speedtest",
      "name": "Speedtest CLI",
      "version": "2.1",
      "author": "sivel",
      "description": "Test your internet speed",
      "category": "tools",
      "install_type": "script",
      "install_cmd": "pip install speedtest-cli",
      "size": "100KB"
    },
    {
      "id": "cowsay",
      "name": "Cowsay",
      "version": "3.04",
      "author": "Tony Monroe",
      "description": "Talking cow ASCII art",
      "category": "games",
      "install_type": "pkg",
      "install_cmd": "pkg install cowsay -y",
      "size": "50KB"
    },
    {
      "id": "figlet",
      "name": "FIGlet",
      "version": "2.2.5",
      "author": "FIGlet",
      "description": "Make large ASCII art text",
      "category": "tools",
      "install_type": "pkg",
      "install_cmd": "pkg install figlet -y",
      "size": "100KB"
    },
    {
      "id": "sl",
      "name": "SL (Steam Locomotive)",
      "version": "5.02",
      "author": "mtoyoda",
      "description": "Cure your bad habit of typing sl",
      "category": "games",
      "install_type": "pkg",
      "install_cmd": "pkg install sl -y",
      "size": "20KB"
    }
  ]
}
INDEXEOF
    echo -e "${GREEN}Created local store index${NC}"
}

# Browse all apps
browse_apps() {
    if [ ! -f "$CACHE_DIR/index.json" ]; then
        sync_index
    fi

    echo -e "${CYAN}╔════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║         DITTO STORE - All Apps         ║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════╝${NC}"
    echo ""

    # Parse and display apps
    local count=0
    while IFS='|' read -r id name cat desc; do
        if [ -n "$id" ]; then
            printf "${GREEN}%-20s${NC} ${YELLOW}[%s]${NC}\n" "$name" "$cat"
            printf "  ${BLUE}%s${NC}\n" "$desc"
            printf "  Install: ${MAGENTA}store install %s${NC}\n\n" "$id"
            ((count++))
        fi
    done < <(python3 << PYEOF
import json
with open('$CACHE_DIR/index.json') as f:
    data = json.load(f)
for app in data.get('apps', []):
    print(f"{app['id']}|{app['name']}|{app['category']}|{app['description']}")
PYEOF
)

    echo -e "${CYAN}Total: $count apps available${NC}"
}

# Search apps
search_apps() {
    local query="$1"
    if [ -z "$query" ]; then
        echo -e "${RED}Usage: store search <query>${NC}"
        return 1
    fi

    if [ ! -f "$CACHE_DIR/index.json" ]; then
        sync_index
    fi

    echo -e "${CYAN}Searching for '$query'...${NC}"
    echo ""

    python3 << PYEOF
import json
query = '$query'.lower()
with open('$CACHE_DIR/index.json') as f:
    data = json.load(f)
found = 0
for app in data.get('apps', []):
    if query in app['name'].lower() or query in app['description'].lower() or query in app.get('category', '').lower():
        print(f"\033[0;32m{app['name']}\033[0m [\033[1;33m{app['category']}\033[0m]")
        print(f"  {app['description']}")
        print(f"  Install: \033[0;35mstore install {app['id']}\033[0m")
        print()
        found += 1
print(f'\033[0;36mFound {found} results\033[0m')
PYEOF
}

# Show app info
app_info() {
    local app_id="$1"
    if [ -z "$app_id" ]; then
        echo -e "${RED}Usage: store info <app-id>${NC}"
        return 1
    fi

    if [ ! -f "$CACHE_DIR/index.json" ]; then
        sync_index
    fi

    python3 -c "
import json
app_id = '$app_id'
with open('$CACHE_DIR/index.json') as f:
    data = json.load(f)
for app in data.get('apps', []):
    if app['id'] == app_id:
        print(f\"\033[0;36m╔{'═'*40}╗\033[0m\")
        print(f\"\033[0;36m║ {app['name']:^38} ║\033[0m\")
        print(f\"\033[0;36m╚{'═'*40}╝\033[0m\")
        print()
        print(f\"\033[1;33mID:\033[0m          {app['id']}\")
        print(f\"\033[1;33mVersion:\033[0m     {app['version']}\")
        print(f\"\033[1;33mAuthor:\033[0m      {app['author']}\")
        print(f\"\033[1;33mCategory:\033[0m    {app['category']}\")
        print(f\"\033[1;33mSize:\033[0m        {app['size']}\")
        print(f\"\033[1;33mDescription:\033[0m {app['description']}\")
        print()
        print(f\"\033[0;32mInstall: store install {app['id']}\033[0m\")
        exit(0)
print(f\"\033[0;31mApp '{app_id}' not found\033[0m\")
" 2>/dev/null
}

# Install app
install_app() {
    local app_id="$1"
    if [ -z "$app_id" ]; then
        echo -e "${RED}Usage: store install <app-id>${NC}"
        return 1
    fi

    if [ ! -f "$CACHE_DIR/index.json" ]; then
        sync_index
    fi

    # Get install command
    local install_cmd=$(python3 -c "
import json
app_id = '$app_id'
with open('$CACHE_DIR/index.json') as f:
    data = json.load(f)
for app in data.get('apps', []):
    if app['id'] == app_id:
        print(app['install_cmd'])
        exit(0)
print('NOT_FOUND')
" 2>/dev/null)

    if [ "$install_cmd" = "NOT_FOUND" ]; then
        echo -e "${RED}App '$app_id' not found${NC}"
        return 1
    fi

    echo -e "${CYAN}Installing $app_id...${NC}"
    echo -e "${YELLOW}Running: $install_cmd${NC}"
    echo ""

    # Execute install
    eval "$install_cmd"

    if [ $? -eq 0 ]; then
        # Track installed apps
        echo "$app_id" >> "$STORE_DIR/installed.txt"
        sort -u "$STORE_DIR/installed.txt" -o "$STORE_DIR/installed.txt"
        echo ""
        echo -e "${GREEN}✓ $app_id installed successfully${NC}"
    else
        echo -e "${RED}✗ Installation failed${NC}"
    fi
}

# List installed apps
list_installed() {
    echo -e "${CYAN}Installed Apps:${NC}"
    echo ""

    if [ -f "$STORE_DIR/installed.txt" ]; then
        while read -r app_id; do
            if [ -n "$app_id" ]; then
                echo -e "  ${GREEN}✓${NC} $app_id"
            fi
        done < "$STORE_DIR/installed.txt"
    else
        echo "  (no apps installed via store)"
    fi
    echo ""
}

# Browse by category
browse_category() {
    local category="$1"
    if [ -z "$category" ]; then
        echo -e "${YELLOW}Categories: tools, themes, scripts, games${NC}"
        return
    fi

    if [ ! -f "$CACHE_DIR/index.json" ]; then
        sync_index
    fi

    echo -e "${CYAN}Category: $category${NC}"
    echo ""

    python3 << PYEOF
import json
cat = '$category'.lower()
with open('$CACHE_DIR/index.json') as f:
    data = json.load(f)
found = 0
for app in data.get('apps', []):
    if app.get('category', '').lower() == cat:
        print(f"\033[0;32m{app['name']}\033[0m - {app['description']}")
        print(f"  Install: \033[0;35mstore install {app['id']}\033[0m")
        print()
        found += 1
print(f'\033[0;36m{found} apps in {cat}\033[0m')
PYEOF
}

# Submit app (placeholder)
submit_app() {
    echo -e "${CYAN}Submit Your App to DITTO Store${NC}"
    echo ""
    echo "To submit an app, create a JSON file with:"
    echo ""
    cat << 'EOF'
{
  "id": "your-app-id",
  "name": "Your App Name",
  "version": "1.0.0",
  "author": "your-github-username",
  "description": "What your app does",
  "category": "tools|themes|scripts|games",
  "install_type": "pkg|script|ditto",
  "install_cmd": "command to install",
  "size": "estimated size"
}
EOF
    echo ""
    echo -e "Then submit via: ${MAGENTA}social post store \"New app: your-app-name\"${NC}"
    echo "Or create a PR on github.com/MobileDevCLI/ditto-store"
}

# Main
case "$1" in
    browse|"")
        browse_apps
        ;;
    search)
        search_apps "$2"
        ;;
    info)
        app_info "$2"
        ;;
    install)
        install_app "$2"
        ;;
    uninstall)
        echo "Uninstall: use pkg uninstall or remove script manually"
        ;;
    installed)
        list_installed
        ;;
    update)
        sync_index
        ;;
    sync)
        sync_index
        ;;
    cat)
        browse_category "$2"
        ;;
    submit)
        submit_app
        ;;
    help|-h|--help)
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        show_help
        ;;
esac
