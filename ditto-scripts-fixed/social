#!/data/data/com.termux/files/usr/bin/bash
# DITTO SOCIAL - Community Network
# Discord-style communication for MobileCLI users

SOCIAL_DIR="$HOME/.ditto/social"
FEED_DIR="$SOCIAL_DIR/feed"
DM_DIR="$SOCIAL_DIR/dm"
CONFIG_FILE="$HOME/.ditto/config/social.json"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
WHITE='\033[1;37m'
NC='\033[0m'

mkdir -p "$SOCIAL_DIR" "$FEED_DIR" "$DM_DIR"

show_help() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘     DITTO SOCIAL - Community Hub       â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}Profile:${NC}"
    echo "  social setup              - Set up your profile"
    echo "  social profile            - View your profile"
    echo "  social profile <user>     - View someone's profile"
    echo ""
    echo -e "${YELLOW}Channels:${NC}"
    echo "  social feed               - View community feed"
    echo "  social post <msg>         - Post to general channel"
    echo "  social post help <msg>    - Post to help channel"
    echo "  social post showcase <msg> - Show what you built"
    echo ""
    echo -e "${YELLOW}Interaction:${NC}"
    echo "  social reply <id> <msg>   - Reply to a post"
    echo "  social like <id>          - Like a post"
    echo "  social follow <user>      - Follow a user"
    echo "  social followers          - List your followers"
    echo ""
    echo -e "${YELLOW}Direct Messages:${NC}"
    echo "  social dm <user> <msg>    - Send direct message"
    echo "  social inbox              - View your messages"
    echo ""
    echo -e "${YELLOW}Notifications:${NC}"
    echo "  social notifications      - View notifications"
    echo "  social clear              - Clear notifications"
}

# Setup profile
setup_profile() {
    echo -e "${CYAN}Setting up your DITTO Social profile...${NC}"
    echo ""

    # Get username
    read -p "Username (letters/numbers only): " username
    username=$(echo "$username" | tr -cd 'a-zA-Z0-9_')

    if [ -z "$username" ]; then
        username="user_$(date +%s | tail -c 6)"
    fi

    # Get display name
    read -p "Display name: " displayname
    if [ -z "$displayname" ]; then
        displayname="$username"
    fi

    # Get bio
    read -p "Bio (one line): " bio

    # Get GitHub (optional)
    read -p "GitHub username (optional): " github

    # Save profile
    cat > "$CONFIG_FILE" << EOF
{
  "username": "$username",
  "displayname": "$displayname",
  "bio": "$bio",
  "github": "$github",
  "created": "$(date -Iseconds)",
  "followers": [],
  "following": [],
  "posts": 0
}
EOF

    echo ""
    echo -e "${GREEN}Profile created!${NC}"
    echo -e "Username: ${CYAN}@$username${NC}"
    view_profile
}

# View profile
view_profile() {
    local user="$1"

    if [ -z "$user" ]; then
        # View own profile
        if [ ! -f "$CONFIG_FILE" ]; then
            echo -e "${YELLOW}No profile set up. Run: social setup${NC}"
            return 1
        fi

        echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${CYAN}â•‘           Your Profile                 â•‘${NC}"
        echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

        python3 -c "
import json
with open('$CONFIG_FILE') as f:
    p = json.load(f)
print(f\"\n\033[1;37m@{p['username']}\033[0m\")
print(f\"{p.get('displayname', p['username'])}\")
print(f\"\n{p.get('bio', 'No bio')}\")
if p.get('github'):
    print(f\"\n\033[0;34mGitHub:\033[0m github.com/{p['github']}\")
print(f\"\n\033[0;32mFollowers:\033[0m {len(p.get('followers', []))}  \033[0;32mFollowing:\033[0m {len(p.get('following', []))}\")
print(f\"\033[0;32mPosts:\033[0m {p.get('posts', 0)}\")
" 2>/dev/null
    else
        echo -e "${YELLOW}Viewing profile for @$user (requires network)${NC}"
    fi
}

# Create a post
create_post() {
    local channel="$1"
    shift
    local message="$*"

    # Check if any arguments were provided
    if [ -z "$channel" ]; then
        echo -e "${RED}Usage: social post [channel] <message>${NC}"
        return 1
    fi

    if [ ! -f "$CONFIG_FILE" ]; then
        echo -e "${YELLOW}Set up profile first: social setup${NC}"
        return 1
    fi

    # Get username
    local username=$(python3 -c "import json; print(json.load(open('$CONFIG_FILE'))['username'])" 2>/dev/null)

    # Determine channel - if first arg is a known channel, use rest as message
    # Otherwise first arg is part of message, channel is general
    case "$channel" in
        help|showcase|store|bugs)
            # channel is specified, message is the rest
            if [ -z "$message" ]; then
                echo -e "${RED}Usage: social post $channel <message>${NC}"
                return 1
            fi
            ;;
        *)
            # First word is part of message, channel is general
            message="$channel $message"
            channel="general"
            ;;
    esac

    # Create post using python (more reliable for timestamps and file creation)
    local post_id=$(python3 << PYEOF
import json
import os
import time
import random

timestamp = int(time.time())
rand_id = random.randint(1000, 9999)
post_id = f"{timestamp}_{rand_id}"

# Ensure feed directory exists
feed_dir = "$FEED_DIR/$channel"
os.makedirs(feed_dir, exist_ok=True)

# Create post data
post = {
    "id": post_id,
    "author": "$username",
    "channel": "$channel",
    "message": """$message""",
    "timestamp": time.strftime("%Y-%m-%dT%H:%M:%S%z"),
    "likes": 0,
    "replies": []
}

# Save post file
with open(f"{feed_dir}/{post_id}.json", 'w') as f:
    json.dump(post, f, indent=2)

# Update post count in config
try:
    with open('$CONFIG_FILE', 'r') as f:
        p = json.load(f)
    p['posts'] = p.get('posts', 0) + 1
    with open('$CONFIG_FILE', 'w') as f:
        json.dump(p, f, indent=2)
except:
    pass

print(post_id)
PYEOF
)

    echo -e "${GREEN}Posted to #$channel${NC}"
    echo -e "${CYAN}@$username:${NC} $message"
    echo -e "${YELLOW}Post ID: $post_id${NC}"

    # Show notification
    termux-toast "Posted to #$channel" 2>/dev/null
}

# View feed
view_feed() {
    local channel="${1:-general}"

    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘         #$channel                      ${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    local found=0

    # Check all channels if no specific one
    if [ "$channel" = "all" ]; then
        for ch_dir in "$FEED_DIR"/*/; do
            if [ -d "$ch_dir" ]; then
                for post_file in "$ch_dir"/*.json; do
                    if [ -f "$post_file" ]; then
                        display_post "$post_file"
                        ((found++))
                    fi
                done
            fi
        done
    else
        mkdir -p "$FEED_DIR/$channel"
        for post_file in "$FEED_DIR/$channel"/*.json; do
            if [ -f "$post_file" ]; then
                display_post "$post_file"
                ((found++))
            fi
        done
    fi

    if [ $found -eq 0 ]; then
        echo -e "${YELLOW}No posts yet. Be the first!${NC}"
        echo -e "Post with: ${MAGENTA}social post \"Your message here\"${NC}"
    fi
}

# Display a single post
display_post() {
    local post_file="$1"

    python3 -c "
import json
from datetime import datetime
with open('$post_file') as f:
    p = json.load(f)
# Parse timestamp
try:
    ts = datetime.fromisoformat(p['timestamp'].replace('Z', '+00:00'))
    time_str = ts.strftime('%b %d %H:%M')
except:
    time_str = p['timestamp'][:16]

print(f\"\033[1;37m@{p['author']}\033[0m Â· \033[0;90m{time_str}\033[0m\")
print(f\"{p['message']}\")
print(f\"\033[0;90mâ™¥ {p.get('likes', 0)} Â· ğŸ’¬ {len(p.get('replies', []))} Â· ID: {p['id'][:8]}\033[0m\")
print()
" 2>/dev/null
}

# Like a post
like_post() {
    local post_id="$1"
    if [ -z "$post_id" ]; then
        echo -e "${RED}Usage: social like <post-id>${NC}"
        return 1
    fi

    # Find post
    local found=""
    for post_file in "$FEED_DIR"/*/"$post_id"*.json; do
        if [ -f "$post_file" ]; then
            found="$post_file"
            break
        fi
    done

    if [ -z "$found" ]; then
        echo -e "${RED}Post not found${NC}"
        return 1
    fi

    # Increment likes
    python3 -c "
import json
with open('$found', 'r') as f:
    p = json.load(f)
p['likes'] = p.get('likes', 0) + 1
with open('$found', 'w') as f:
    json.dump(p, f, indent=2)
print(f\"â™¥ Liked! ({p['likes']} total)\")
" 2>/dev/null
}

# Send DM
send_dm() {
    local to_user="$1"
    shift
    local message="$*"

    if [ -z "$to_user" ] || [ -z "$message" ]; then
        echo -e "${RED}Usage: social dm <username> <message>${NC}"
        return 1
    fi

    if [ ! -f "$CONFIG_FILE" ]; then
        echo -e "${YELLOW}Set up profile first: social setup${NC}"
        return 1
    fi

    # Use python for reliable file creation
    python3 << PYEOF
import json
import os
import time
import random

# Get from_user
with open('$CONFIG_FILE') as f:
    from_user = json.load(f)['username']

timestamp = int(time.time())
rand_id = random.randint(1000, 9999)
dm_id = f"{timestamp}_{rand_id}"

# Ensure DM directory exists
dm_dir = "$DM_DIR/$to_user"
os.makedirs(dm_dir, exist_ok=True)

# Create DM data
dm = {
    "id": dm_id,
    "from": from_user,
    "to": "$to_user",
    "message": """$message""",
    "timestamp": time.strftime("%Y-%m-%dT%H:%M:%S%z"),
    "read": False
}

# Save DM file
with open(f"{dm_dir}/{dm_id}.json", 'w') as f:
    json.dump(dm, f, indent=2)
PYEOF

    echo -e "${GREEN}Message sent to @$to_user${NC}"
}

# View inbox
view_inbox() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘            Your Inbox                  â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    local found=0
    for dm_dir in "$DM_DIR"/*/; do
        if [ -d "$dm_dir" ]; then
            for dm_file in "$dm_dir"/*.json; do
                if [ -f "$dm_file" ]; then
                    python3 -c "
import json
with open('$dm_file') as f:
    m = json.load(f)
status = 'â—' if not m.get('read', False) else 'â—‹'
print(f\"\033[1;37m{status} @{m['from']}\033[0m: {m['message'][:50]}...\")
" 2>/dev/null
                    ((found++))
                fi
            done
        fi
    done

    if [ $found -eq 0 ]; then
        echo -e "${YELLOW}No messages${NC}"
    fi
}

# Follow user
follow_user() {
    local user="$1"
    if [ -z "$user" ]; then
        echo -e "${RED}Usage: social follow <username>${NC}"
        return 1
    fi

    if [ ! -f "$CONFIG_FILE" ]; then
        echo -e "${YELLOW}Set up profile first: social setup${NC}"
        return 1
    fi

    python3 -c "
import json
with open('$CONFIG_FILE', 'r') as f:
    p = json.load(f)
following = p.get('following', [])
if '$user' not in following:
    following.append('$user')
    p['following'] = following
    with open('$CONFIG_FILE', 'w') as f:
        json.dump(p, f, indent=2)
    print(f'\033[0;32mNow following @$user\033[0m')
else:
    print(f'\033[0;33mAlready following @$user\033[0m')
" 2>/dev/null
}

# View notifications
view_notifications() {
    echo -e "${CYAN}Notifications:${NC}"
    echo ""
    echo -e "${YELLOW}(Notifications sync when connected to community)${NC}"
    echo ""

    # Show recent activity
    echo -e "${GREEN}Recent Activity:${NC}"
    local count=0
    for post_file in "$FEED_DIR"/*/*.json; do
        if [ -f "$post_file" ] && [ $count -lt 5 ]; then
            python3 -c "
import json
with open('$post_file') as f:
    p = json.load(f)
print(f\"  @{p['author']} posted in #{p['channel']}\")
" 2>/dev/null
            ((count++))
        fi
    done
}

# Main
case "$1" in
    setup)
        setup_profile
        ;;
    profile)
        view_profile "$2"
        ;;
    feed)
        view_feed "$2"
        ;;
    post)
        shift
        create_post "$@"
        ;;
    like)
        like_post "$2"
        ;;
    reply)
        echo "Reply: TODO (add to post's replies array)"
        ;;
    dm)
        shift
        send_dm "$@"
        ;;
    inbox)
        view_inbox
        ;;
    follow)
        follow_user "$2"
        ;;
    followers)
        python3 -c "import json; p=json.load(open('$CONFIG_FILE')); print('Followers:', len(p.get('followers',[]))); print('Following:', ', '.join(p.get('following',[])))" 2>/dev/null
        ;;
    notifications|notif)
        view_notifications
        ;;
    clear)
        echo "Notifications cleared"
        ;;
    help|-h|--help|"")
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        show_help
        ;;
esac
